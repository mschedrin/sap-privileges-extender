# Swift/macOS development image with Swift compiler, Go toolchain, and ralphex
# Tailored for macOS/Swift app development (PrivilegesExtender and similar projects)
FROM ghcr.io/umputun/ralphex:latest AS ralphex

FROM swift:6.2.3-noble

LABEL org.opencontainers.image.description="Autonomous plan execution with Claude Code - Swift/macOS development image"

# baseimage-compatible environment variables
ENV TERM=xterm-color \
    TIME_ZONE=America/Chicago \
    APP_USER=app \
    APP_UID=1001 \
    DOCKER_GID=999 \
    USE_BUILTIN_RIPGREP=0 \
    RALPHEX_DOCKER=1

# install base tools (matching ralphex Dockerfile + extras)
RUN apt-get update && apt-get install -y --no-install-recommends \
    nodejs npm \
    python3 python3-pip \
    ripgrep fzf git openssh-client bash \
    make gcc \
    gosu \
    jq shellcheck unzip wget curl \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# set timezone
RUN cp /usr/share/zoneinfo/${TIME_ZONE} /etc/localtime && \
    echo "${TIME_ZONE}" > /etc/timezone

# create app user (matching baseimage conventions)
RUN groupadd -g ${DOCKER_GID} docker && \
    groupadd -g ${APP_UID} app && \
    useradd -u ${APP_UID} -g app -G docker -m -s /bin/bash app

# install claude code and codex globally
RUN npm install -g @anthropic-ai/claude-code @openai/codex && \
    command -v claude >/dev/null || { echo "error: claude CLI not found"; exit 1; } && \
    command -v codex >/dev/null || { echo "error: codex CLI not found"; exit 1; }

# install latest go from official distribution
ARG GO_VERSION=1.26.0
RUN ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    wget -qO- "https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz" | tar -xz -C /usr/local

# set go environment
ENV GOROOT=/usr/local/go
ENV GOPATH=/home/app/go
ENV PATH="${PATH}:${GOROOT}/bin:${GOPATH}/bin"

# install go development tools (golangci-lint, moq, goimports) — pinned versions
ARG GOLANGCI_LINT_VERSION=v2.9.0
ARG GOLANGCI_LINT_SHA256_AMD64=493aaaca2eba6c8bcef847d92716bbd91bbac4b22cdbb0ab5b6a581b32946091
ARG GOLANGCI_LINT_SHA256_ARM64=94e80cdb51c73c20a313bd3afa1fb23137728813c19fd730248a1e8678fcc46d
RUN ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    TARBALL="golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-${ARCH}.tar.gz" && \
    wget -qO "/tmp/${TARBALL}" "https://github.com/golangci/golangci-lint/releases/download/${GOLANGCI_LINT_VERSION}/${TARBALL}" && \
    if [ "$ARCH" = "amd64" ]; then EXPECTED="${GOLANGCI_LINT_SHA256_AMD64}"; else EXPECTED="${GOLANGCI_LINT_SHA256_ARM64}"; fi && \
    echo "${EXPECTED}  /tmp/${TARBALL}" | sha256sum -c - && \
    tar -xzf "/tmp/${TARBALL}" -C /tmp && \
    mv "/tmp/golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-${ARCH}/golangci-lint" /usr/local/bin/golangci-lint && \
    chmod +x /usr/local/bin/golangci-lint && \
    rm -rf "/tmp/${TARBALL}" "/tmp/golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-${ARCH}" && \
    GOBIN=/usr/local/bin go install github.com/matryer/moq@v0.5.3 && \
    GOBIN=/usr/local/bin go install golang.org/x/tools/cmd/goimports@v0.33.0

# install additional development tools
ARG YQ_VERSION=v4.52.4
ARG YQ_SHA256_AMD64=0c4d965ea944b64b8fddaf7f27779ee3034e5693263786506ccd1c120f184e8c
ARG YQ_SHA256_ARM64=4c2cc022a129be5cc1187959bb4b09bebc7fb543c5837b93001c68f97ce39a5d
RUN pip3 install --break-system-packages yamllint && \
    ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_${ARCH}" && \
    if [ "$ARCH" = "amd64" ]; then EXPECTED="${YQ_SHA256_AMD64}"; else EXPECTED="${YQ_SHA256_ARM64}"; fi && \
    echo "${EXPECTED}  /usr/local/bin/yq" | sha256sum -c - && \
    chmod +x /usr/local/bin/yq

# install Swift development tools (linter + formatter) — pinned versions
ARG SWIFTLINT_VERSION=0.63.2
ARG SWIFTLINT_SHA256_AMD64=dd1017cfd20a1457f264590bcb5875a6ee06cd75b9a9d4f77cd43a552499143b
ARG SWIFTLINT_SHA256_ARM64=104dedff762157f5cff7752f1cc2a289b60f3ea677e72d651c6f3a3287fdd948
RUN ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    wget -qO /tmp/swiftlint.zip "https://github.com/realm/SwiftLint/releases/download/${SWIFTLINT_VERSION}/swiftlint_linux_${ARCH}.zip" && \
    if [ "$ARCH" = "amd64" ]; then EXPECTED="${SWIFTLINT_SHA256_AMD64}"; else EXPECTED="${SWIFTLINT_SHA256_ARM64}"; fi && \
    echo "${EXPECTED}  /tmp/swiftlint.zip" | sha256sum -c - && \
    unzip -o /tmp/swiftlint.zip swiftlint -d /tmp && \
    mv /tmp/swiftlint /usr/local/bin/swiftlint && \
    chmod +x /usr/local/bin/swiftlint && \
    rm -f /tmp/swiftlint.zip

ARG SWIFTFORMAT_VERSION=0.59.1
ARG SWIFTFORMAT_SHA256_AMD64=150d9693570cf234ec91d8a03ba7165bd36a78335c5e40ed91e4c013a492eb54
ARG SWIFTFORMAT_SHA256_ARM64=c55cea3543dd8488863d14132fa677db765c8f0ad5a6e6184cf822ca626bb1db
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        ZIP_NAME="swiftformat_linux.zip"; \
        BIN_NAME="swiftformat_linux"; \
        EXPECTED="${SWIFTFORMAT_SHA256_AMD64}"; \
    else \
        ZIP_NAME="swiftformat_linux_aarch64.zip"; \
        BIN_NAME="swiftformat_linux_aarch64"; \
        EXPECTED="${SWIFTFORMAT_SHA256_ARM64}"; \
    fi && \
    wget -qO /tmp/swiftformat.zip "https://github.com/nicklockwood/SwiftFormat/releases/download/${SWIFTFORMAT_VERSION}/${ZIP_NAME}" && \
    echo "${EXPECTED}  /tmp/swiftformat.zip" | sha256sum -c - && \
    unzip -o /tmp/swiftformat.zip -d /tmp && \
    mv "/tmp/${BIN_NAME}" /usr/local/bin/swiftformat && \
    chmod +x /usr/local/bin/swiftformat && \
    rm -f /tmp/swiftformat.zip

# copy ralphex binary and init script from official image
COPY --from=ralphex /srv/ralphex /srv/ralphex
COPY --from=ralphex /srv/init.sh /srv/init.sh
RUN chmod +x /srv/ralphex /srv/init.sh

# copy baseimage-compatible entrypoint (adapted for Ubuntu — uses gosu instead of su-exec)
COPY scripts/docker-init.sh /init.sh
RUN chmod +x /init.sh

# expose web dashboard port
EXPOSE 8080

WORKDIR /workspace

ENTRYPOINT ["/init.sh"]
CMD ["/srv/ralphex"]
